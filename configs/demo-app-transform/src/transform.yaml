version: 19.12

#
# Configuration for an IAG container.
#
# This file specifies HTTP Transformation rules and response content
# injection policies.  It is designed to be used with a configuration file
# specifying basic configuration.
#

policies:

  http_transformations:
    response:

        #
        # An HTTP transformation policy, applied to all
        # resources, which will add the 'IAG_HTTP_XFORM_RESP: HELLO_WORLD'
        # HTTP header to all responses.
        #
      - name: "AddResponseHeader"
        method: "*"
        paths:
          - "*"
        rule: |
          <?xml version="1.0" encoding="UTF-8"?>
          <xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">

          <xsl:strip-space elements="*" />

          <xsl:template match="/">
            <HTTPResponseChange>
              <xsl:apply-templates />
            </HTTPResponseChange>
          </xsl:template>

          <xsl:template match="//HTTPRequest/Headers">
            <Header action="add" name="IAG_HTTP_XFORM_RESP">HELLO_WORLD</Header>
          </xsl:template>

          </xsl:stylesheet>

    request:

        #
        # An HTTP transformation policy, applied to all
        # resources, which will add the URI of the request to a header
        # called myuri.
        #
      - name: "AddUriToHeader"
        method: "*"
        paths:
          - "*"
        rule: |
          <?xml version="1.0" encoding="UTF-8"?>
          <xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">

          <xsl:strip-space elements="*" />

          <xsl:variable name="varUriGlobal">
           <xsl:value-of select="//HTTPRequest/RequestLine/URI"/>
          </xsl:variable>

          <xsl:template match="/">
            <HTTPRequestChange>
              <xsl:apply-templates />
            </HTTPRequestChange>
          </xsl:template>

          <xsl:template match="//HTTPRequest/Headers">
          <xsl:choose>
            <xsl:when test="Header/@name='myuri'" />
            <xsl:otherwise>
              <Header action="add" name="myuri"><xsl:value-of select="$varUriGlobal"/></Header>
            </xsl:otherwise>
          </xsl:choose>
          </xsl:template>

          </xsl:stylesheet>

  #
  # A content injection policy, applied to the / resource, which will
  # add a link to the demo app to the standard home page.  This is a
  # contrived example but shows how the functionality works.
  #

  content_injection:
    - name: "content_injection_1"
      paths:
        - "/"
      location: "*span*"
      content: "<a href=\"/demo/userhome\">Demo Home</a><br/>"
